<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaIA - Llave de Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        #loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #loader.active { opacity: 1; visibility: visible; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 4px solid #ffffff; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <!-- Encabezado -->
        <header class="flex justify-between items-center mb-6 p-4 bg-white shadow-md rounded-lg">
            <h1 class="text-3xl font-bold text-blue-700">
                <span class="inline-block align-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg>
                </span>
                <span class="ml-2 align-middle">AulaIA (Acceso)</span>
            </h1>
            <div id="user-info" class="text-right">
                <span id="role-display" class="font-semibold text-lg"></span>
                <span id="user-email" class="text-sm text-gray-500 block"></span>
                <button id="logout-btn" class="ml-4 bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition hidden">Salir</button>
            </div>
        </header>

        <!-- Vista de Carga -->
        <div id="auth-loading-view" class="view text-center p-10" style="display: block;">
            <h2 class="text-2xl font-semibold">Conectando...</h2>
            <p class="text-gray-600">Verificando credenciales.</p>
        </div>

        <!-- Vista de Selección de Rol (Login) -->
        <div id="role-view" class="view max-w-md mx-auto text-center p-10 bg-white shadow-xl rounded-2xl">
            <h2 class="text-2xl font-semibold mb-6">¿Cómo quieres acceder?</h2>
            
            <!-- ALERTA DE ERROR -->
            <div id="login-error-alert" class="hidden mb-4 p-4 text-sm text-red-700 bg-red-100 rounded-lg text-left" role="alert">
                <p class="font-bold">No se pudo iniciar sesión.</p>
                <p>Si estás usando <strong>Modo Incógnito</strong> o Privado, la redirección de Google no funcionará.</p>
                <p class="mt-2">Por favor, prueba en una <strong>ventana normal</strong> del navegador.</p>
            </div>

            <div class="space-y-4">
                <button id="teacher-login-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-blue-700 transition shadow-lg flex items-center justify-center">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,41.219,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l0.001-0.001l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                    Acceder como Profesor (Google)
                </button>
                <div class="relative py-3">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-300"></div></div>
                    <div class="relative flex justify-center"><span class="bg-white px-2 text-sm text-gray-500">o</span></div>
                </div>
                <button id="student-role-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-green-700 transition shadow-lg">
                    Soy Alumno
                </button>
            </div>
        </div>

        <!-- VISTA DE PROFESOR (HUB) -->
        <div id="teacher-hub-view" class="view grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-4">
                <div class="bg-white p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-700">Acciones</h2>
                    <button id="show-create-classroom-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                        Crear Nueva Aula
                    </button>
                </div>
            </div>
            <div class="md:col-span-2 space-y-4">
                <div class="bg-white p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">Mis Aulas Creadas</h2>
                    <div id="teacher-classrooms-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
        
        <!-- VISTA DE PROFESOR (CREAR) -->
        <div id="teacher-create-view" class="view bg-white p-6 shadow-lg rounded-lg max-w-3xl mx-auto">
            <button id="back-to-hub-btn" class="mb-4 text-sm text-blue-600 hover:underline">&larr; Volver al Centro de Aulas</button>
            <h2 id="create-view-title" class="text-2xl font-bold mb-4 border-b pb-2 text-blue-700">Crear Nueva Aula</h2>
            <form id="create-classroom-form" class="space-y-4">
                <div>
                    <label for="classroom-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Aula / Tema</label>
                    <input type="text" id="classroom-name" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ej: Historia de Roma" required>
                </div>
                <div>
                    <label for="classroom-students" class="block text-sm font-medium text-gray-700 mb-1">IDEA o Nick de Alumnos (1 por línea)</label>
                    <textarea id="classroom-students" rows="6" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="idea_alumno1&#10;nick_alumno2&#10;idea_alumno3" required></textarea>
                </div>
                <div>
                    <label for="classroom-text" class="block text-sm font-medium text-gray-700 mb-1">Texto para Analizar</label>
                    <p class="text-xs text-gray-500 mb-2">Nota: La carga de PDF no está soportada. Copia y pega el texto aquí.</p>
                    <textarea id="classroom-text" rows="10" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Pega aquí el contenido del tema..." required></textarea>
                </div>
                <div>
                    <label for="classroom-rubric" class="block text-sm font-medium text-gray-700 mb-1">Rúbrica de Evaluación (Opcional)</label>
                    <textarea id="classroom-rubric" rows="4" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Criterios de evaluación..."></textarea>
                </div>
                <button id="create-view-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                    Guardar Aula
                </button>
            </form>
        </div>

        <!-- VISTA DE ALUMNO -->
        <div id="student-login-view" class="view max-w-md mx-auto p-10 bg-white shadow-xl rounded-2xl">
            <button id="back-to-role-btn" class="mb-4 text-sm text-blue-600 hover:underline">&larr; Volver</button>
            <h2 class="text-2xl font-semibold mb-6 text-green-700">Acceso de Alumno</h2>
            <form id="student-login-form" class="space-y-4">
                <div>
                    <label for="student-classroom-select" class="block text-sm font-medium text-gray-700 mb-1">1. Selecciona tu Aula</label>
                    <select id="student-classroom-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required>
                        <option value="" disabled selected>Cargando aulas...</option>
                    </select>
                </div>
                <div>
                    <label for="student-nick" class="block text-sm font-medium text-gray-700 mb-1">2. Introduce tu IDEA o Nick</label>
                    <input type="text" id="student-nick" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Tu IDEA o Nick" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-700 transition shadow-lg">Entrar</button>
            </form>
        </div>

    </div> <!-- Fin #app -->

    <!-- Loader -->
    <div id="loader"><div class="spinner"></div></div>

    <!-- Modales -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="message-title" class="text-xl font-bold mb-4"></h3>
            <p id="message-body"></p>
            <button id="message-close-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Entendido</button>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="confirm-title" class="text-xl font-bold mb-4"></h3>
            <p id="confirm-body"></p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithRedirect, getRedirectResult, 
            onAuthStateChanged, GoogleAuthProvider, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, 
            collection, query, where, serverTimestamp, deleteDoc, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const RESUMEN_APP_URL = "https://vferjim688-droid.github.io/Actividad-de-Resumen/";
        const TEACHER_DOMAIN = "@g.educaand.es";

        const firebaseConfig = {
            apiKey: "AIzaSyCrZRRrK2pV8-qgbv4SkutKE2LSQFPJE-Q",
            authDomain: "aulaia-393c0.firebaseapp.com",
            projectId: "aulaia-393c0",
            storageBucket: "aulaia-393c0.appspot.com",
            messagingSenderId: "485029010497",
            appId: "1:485029010497:web:1ebf3b0a80781d30307ac0"
        };
        
        const appId = firebaseConfig.projectId || 'aula-ia-default';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribeClassrooms = () => {};
        let currentEditingClassroomId = null;
        let classroomToDeleteId = null;

        // --- GESTIÓN DE ESTADO Y REDIRECT ---
        
        // Detectar si volvemos de un intento de login
        const isReturningFromLogin = sessionStorage.getItem('isLoggingIn') === 'true';

        getRedirectResult(auth).then((result) => {
            if (result) {
                sessionStorage.removeItem('isLoggingIn'); // Limpiar flag
                const user = result.user;
                if (user.email && user.email.endsWith(TEACHER_DOMAIN)) {
                    setRole('teacher', user);
                } else {
                    signOut(auth);
                    showMessage("Acceso Denegado", `Solo cuentas ${TEACHER_DOMAIN} permitidas.`);
                }
            }
        }).catch((error) => {
            console.error("Error redirect:", error);
            sessionStorage.removeItem('isLoggingIn');
            showMessage("Error de Acceso", error.message);
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            // Ocultar loader inicial
            document.getElementById('auth-loading-view').style.display = 'none';

            if (user) {
                if (user.email && user.email.endsWith(TEACHER_DOMAIN)) {
                    setRole('teacher', user);
                } else if (user.isAnonymous) {
                    setRole('student');
                } else {
                    // Usuario logueado pero no cumple requisitos (o pendiente de redirect)
                    if (!isReturningFromLogin) showView('role');
                }
            } else {
                // NO hay usuario logueado
                if (isReturningFromLogin) {
                    // ¡OJO! Volvimos de Google pero NO hay usuario.
                    // Esto pasa en Incógnito o si se bloquean cookies de terceros.
                    sessionStorage.removeItem('isLoggingIn');
                    document.getElementById('login-error-alert').classList.remove('hidden');
                }
                showView('role');
            }
        });

        function showView(viewId) {
            Object.values({
                role: document.getElementById('role-view'),
                teacherHub: document.getElementById('teacher-hub-view'),
                teacherCreate: document.getElementById('teacher-create-view'),
                studentLogin: document.getElementById('student-login-view')
            }).forEach(v => v.style.display = 'none');
            
            const view = document.getElementById(viewId === 'role' ? 'role-view' : 
                                               viewId === 'teacher' ? 'teacher-hub-view' : 
                                               viewId === 'student' ? 'student-login-view' : viewId);
            if(view) view.style.display = (viewId === 'teacherHub') ? 'grid' : 'block';
            
            if (viewId === 'role') {
                document.getElementById('logout-btn').classList.add('hidden');
                document.getElementById('user-info').classList.add('hidden');
            } else {
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
            }
        }

        function setRole(role, user) {
            if (role === 'teacher') {
                document.getElementById('role-display').textContent = 'Profesor';
                document.getElementById('user-email').textContent = user.email;
                showView('teacherHub');
                loadTeacherClassrooms(user.email);
            } else {
                document.getElementById('role-display').textContent = 'Alumno';
                document.getElementById('user-email').textContent = 'Modo Alumno';
                showView('studentLogin');
                loadStudentClassroomList();
            }
        }

        // --- EVENTOS ---

        document.getElementById('teacher-login-btn').addEventListener('click', () => {
            // Marcar que estamos intentando loguearnos
            sessionStorage.setItem('isLoggingIn', 'true');
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ 'hd': 'g.educaand.es' });
            signInWithRedirect(auth, provider);
        });

        document.getElementById('student-role-btn').addEventListener('click', async () => {
            if (!currentUser) await signInAnonymously(auth);
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).then(() => window.location.reload()));

        // --- FUNCIONES DE DATOS ---

        function loadTeacherClassrooms(email) {
            unsubscribeClassrooms();
            const list = document.getElementById('teacher-classrooms-list');
            list.innerHTML = '<p>Cargando...</p>';
            
            const q = query(collection(db, `artifacts/${appId}/public/data/classrooms`), where("teacherId", "==", email));
            
            unsubscribeClassrooms = onSnapshot(q, (snap) => {
                list.innerHTML = snap.empty ? '<p class="text-gray-500">No hay aulas creadas.</p>' : '';
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <h4 class="font-bold text-blue-600 cursor-pointer hover:underline" onclick="window.location.href='${RESUMEN_APP_URL}?aulaId=${docSnap.id}'">${data.name}</h4>
                            <span class="text-xs text-gray-500">${data.studentList?.length || 0} alumnos</span>
                        </div>
                        <div>
                            <button class="text-yellow-600 mr-2" onclick="window.editClass('${docSnap.id}')">Editar</button>
                            <button class="text-red-600" onclick="window.deleteClass('${docSnap.id}')">Borrar</button>
                        </div>`;
                    list.appendChild(div);
                });
            }, (err) => {
                console.error(err);
                // Si falla, mostrar el enlace de índice en consola
                console.log("SI VES UN ERROR DE ÍNDICE, HAZ CLIC EN EL ENLACE DE LA CONSOLA"); 
                showMessage("Error", "No se pudieron cargar las aulas. Revisa la consola (F12) si falta un índice.");
            });
        }

        // Exponer funciones al window para los botones HTML generados
        window.editClass = async (id) => {
            currentEditingClassroomId = id;
            const snap = await getDoc(doc(db, `artifacts/${appId}/public/data/classrooms`, id));
            const data = snap.data();
            document.getElementById('classroom-name').value = data.name;
            document.getElementById('classroom-students').value = (data.studentList || []).join('\n');
            document.getElementById('classroom-text').value = data.sourceText;
            document.getElementById('classroom-rubric').value = data.rubric || '';
            document.getElementById('create-view-title').textContent = 'Editar Aula';
            document.getElementById('create-view-submit-btn').textContent = 'Actualizar';
            showView('teacherCreate');
        };

        window.deleteClass = (id) => {
            classroomToDeleteId = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
        };

        // Crear/Editar Aula
        document.getElementById('create-classroom-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('classroom-name').value;
            const students = document.getElementById('classroom-students').value.split('\n').map(s=>s.trim()).filter(s=>s);
            const text = document.getElementById('classroom-text').value;
            const rubric = document.getElementById('classroom-rubric').value;

            if(!name || !students.length || !text) return showMessage("Error", "Faltan datos.");

            const data = { 
                name, studentList: students, sourceText: text, rubric, 
                teacherId: currentUser.email, updatedAt: serverTimestamp() 
            };

            try {
                if(currentEditingClassroomId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/classrooms`, currentEditingClassroomId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/classrooms`), data);
                }
                showMessage("Éxito", "Aula guardada.");
                setRole('teacher', currentUser);
            } catch(e) { console.error(e); showMessage("Error", e.message); }
        });
        
        // Lógica Alumno (Simplificada)
        async function loadStudentClassroomList() {
            const sel = document.getElementById('student-classroom-select');
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/classrooms`)), (snap) => {
                sel.innerHTML = '<option disabled selected>Selecciona...</option>';
                snap.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.data().name;
                    opt.dataset.list = JSON.stringify(d.data().studentList || []);
                    sel.appendChild(opt);
                });
            });
        }
        
        document.getElementById('student-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const sel = document.getElementById('student-classroom-select');
            const nick = document.getElementById('student-nick').value.trim();
            const list = JSON.parse(sel.options[sel.selectedIndex].dataset.list || '[]');
            
            if(list.some(n => n.toLowerCase() === nick.toLowerCase())) {
                window.location.href = `${RESUMEN_APP_URL}?aulaId=${sel.value}&alumnoId=${encodeURIComponent(nick)}`;
            } else {
                showMessage("Error", "No estás en la lista.");
            }
        });

        // UI Helpers
        function showMessage(t, b) {
            document.getElementById('message-title').textContent = t;
            document.getElementById('message-body').textContent = b;
            document.getElementById('message-modal').classList.remove('hidden');
        }
        document.getElementById('message-close-btn').addEventListener('click', () => document.getElementById('message-modal').classList.add('hidden'));
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => document.getElementById('confirm-modal').classList.add('hidden'));
        document.getElementById('confirm-action-btn').addEventListener('click', async () => {
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/classrooms`, classroomToDeleteId));
            document.getElementById('confirm-modal').classList.add('hidden');
            showMessage("Borrado", "Aula eliminada.");
        });
        
        document.getElementById('back-to-hub-btn').addEventListener('click', () => setRole('teacher', currentUser));
        document.getElementById('back-to-role-btn').addEventListener('click', () => {
            // Si es alumno (anónimo), al volver atrás queremos resetear
            // Pero signOut borraría el anónimo. Simplemente recargamos para limpiar.
            window.location.reload();
        });

    </script>
</body>
</html>
