<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaIA - Selección de Rol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .view { display: none; }
        .card { max-width: 500px; }
        .btn-primary { background-color: #4f46e5; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-secondary { background-color: #f0f4ff; color: #4f46e5; border: 1px solid #c7d2fe; transition: 0.2s; }
        .btn-secondary:hover:not(:disabled) { background-color: #e0e7ff; }
        button:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(100%); }
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        #loader.hidden { display: none; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Tarjeta de Selección -->
    <div id="role-selection" class="card bg-white p-8 rounded-xl shadow-2xl w-full text-center">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Bienvenido a AulaIA</h1>
        <p class="text-lg text-gray-500 mb-8">Selecciona tu perfil para continuar.</p>

        <div class="space-y-4">
            <button id="profesoradoBtn" disabled class="btn-primary w-full py-4 rounded-xl text-xl font-semibold flex items-center justify-center space-x-3">
                <span>Acceso Profesorado</span>
            </button>
            <button id="alumnadoBtn" disabled class="btn-secondary w-full py-4 rounded-xl text-xl font-semibold flex items-center justify-center space-x-3">
                <span>Acceso Alumnado</span>
            </button>
        </div>

        <p id="statusMessage" class="mt-6 text-indigo-600 font-medium">Iniciando sistema...</p>
        <p class="text-xs text-gray-400 mt-6">IES Las Carabelas</p>
    </div>

    <!-- Modal Mensajes -->
    <div id="messageModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-gray-800"></h3>
            <p id="modalBody" class="text-gray-600 mb-4"></p>
            <button id="modalCloseBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Aceptar</button>
        </div>
    </div>

    <div id="loader" class="hidden"><div class="spinner"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURACIÓN REAL (RESTAURADA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrZRRrK2pV8-qgbv4SkutKE2LSQFPJE-Q",
            authDomain: "aulaia-393c0.firebaseapp.com",
            projectId: "aulaia-393c0",
            storageBucket: "aulaia-393c0.appspot.com",
            messagingSenderId: "485029010497",
            appId: "1:485029010497:web:1ebf3b0a80781d30307ac0"
        };

        // --- ESTADO ---
        let app, auth;
        let initialDataLoaded = false;
        let watchdogTimer = null;

        const profesoradoBtn = document.getElementById('profesoradoBtn');
        const alumnadoBtn = document.getElementById('alumnadoBtn');
        const statusMessage = document.getElementById('statusMessage');
        const loader = document.getElementById('loader');
        const messageModal = document.getElementById('messageModal');

        function enableButtons() {
            profesoradoBtn.disabled = false;
            alumnadoBtn.disabled = false;
            statusMessage.textContent = 'Sistema listo. Elige tu opción.';
            statusMessage.classList.remove('text-indigo-600');
            statusMessage.classList.add('text-green-600');
        }

        function showMessage(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = body;
            messageModal.classList.remove('hidden');
        }

        document.getElementById('modalCloseBtn').addEventListener('click', () => messageModal.classList.add('hidden'));

        // Navegación simple a los otros archivos HTML
        profesoradoBtn.addEventListener('click', () => window.location.href = 'profesorado.html');
        alumnadoBtn.addEventListener('click', () => window.location.href = 'llave_acceso.html');

        window.onload = async () => {
            // Watchdog de seguridad: si en 4 segundos no carga, forzar habilitación
            watchdogTimer = setTimeout(() => {
                if (!initialDataLoaded) {
                    console.warn("Watchdog activado.");
                    enableButtons();
                }
            }, 4000);

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // Comprobación rápida de sesión
                onAuthStateChanged(auth, (user) => {
                    initialDataLoaded = true;
                    clearTimeout(watchdogTimer);
                    
                    if (user) {
                        console.log("Usuario detectado:", user.uid);
                    } else {
                        // Si no hay usuario, intentamos anónimo para asegurar conexión
                        signInAnonymously(auth).catch(e => console.warn("Login anónimo falló", e));
                    }
                    enableButtons();
                });

            } catch (error) {
                console.error("Error fatal:", error);
                // En caso de error grave, habilitamos botones para no bloquear la UI
                // (Los errores reales saldrán en la siguiente página)
                enableButtons(); 
            }
        };
    </script>
</body>
</html>
