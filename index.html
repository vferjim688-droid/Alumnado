<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaIA - Llave de Acceso</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ocultar vistas por defecto */
        .view {
            display: none;
        }
        /* Estilos para el loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #loader.active {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal de la aplicación -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <!-- Encabezado -->
        <header class="flex justify-between items-center mb-6 p-4 bg-white shadow-md rounded-lg">
            <h1 class="text-3xl font-bold text-blue-700">
                <span class="inline-block align-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                </span>
                <span class="ml-2 align-middle">AulaIA (Acceso)</span>
            </h1>
            <div id="user-info" class="text-right">
                <span id="role-display" class="font-semibold text-lg"></span>
                <button id="logout-btn" class="ml-4 bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition hidden">Salir</button>
            </div>
        </header>

        <!-- Vista de Carga de Autenticación -->
        <div id="auth-loading-view" class="text-center p-10">
            <h2 class="text-2xl font-semibold">Conectando...</h2>
            <p class="text-gray-600">Iniciando la aplicación de forma segura.</p>
        </div>

        <!-- Vista de Selección de Rol -->
        <div id="role-view" class="view max-w-md mx-auto text-center p-10 bg-white shadow-xl rounded-2xl">
            <h2 class="text-2xl font-semibold mb-6">¿Cómo quieres acceder?</h2>
            <div class="space-y-4">
                <button id="teacher-role-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-blue-700 transition shadow-lg">
                    Soy Profesor
                </button>
                <button id="student-role-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-green-700 transition shadow-lg">
                    Soy Alumno
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-6">ID de Sesión: <span id="session-id" class="font-mono"></span></p>
        </div>

        <!-- ============================================= -->
        <!-- VISTA DE PROFESOR (HUB) -->
        <!-- ============================================= -->
        <div id="teacher-hub-view" class="view grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Columna 1: Acciones -->
            <div class="md:col-span-1 space-y-4">
                <div class="bg-white p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-700">Acciones</h2>
                    <button id="show-create-classroom-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                        Crear Nueva Aula
                    </button>
                </div>
            </div>

            <!-- Columna 2 y 3: Aulas Creadas -->
            <div class="md:col-span-2 space-y-4">
                <div class="bg-white p-6 shadow-lg rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">Mis Aulas Creadas</h2>
                    <div id="teacher-classrooms-list" class="space-y-4">
                        <!-- Las aulas se cargarán aquí -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- VISTA DE PROFESOR (CREAR AULA) -->
        <!-- ============================================= -->
        <div id="teacher-create-view" class="view bg-white p-6 shadow-lg rounded-lg max-w-3xl mx-auto">
            <button id="back-to-hub-btn" class="mb-4 text-sm text-blue-600 hover:underline">&larr; Volver al Centro de Aulas</button>
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-700">Crear Nueva Aula</h2>
            <form id="create-classroom-form" class="space-y-4">
                <div>
                    <label for="classroom-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Aula / Tema</label>
                    <input type="text" id="classroom-name" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ej: Historia de Roma" required>
                </div>
                
                <div>
                    <label for="classroom-students" class="block text-sm font-medium text-gray-700 mb-1">IDEA o Nick de Alumnos (1 por línea)</label>
                    <textarea id="classroom-students" rows="6" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="idea_alumno1&#10;nick_alumno2&#10;idea_alumno3" required></textarea>
                </div>

                <div>
                    <label for="classroom-text" class="block text-sm font-medium text-gray-700 mb-1">Texto para Analizar</label>
                    <p class="text-xs text-gray-500 mb-2">Nota: La carga de PDF no está soportada. Por favor, copie y pegue el texto del documento aquí.</p>
                    <textarea id="classroom-text" rows="10" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Pega aquí el contenido del tema..." required></textarea>
                </div>
                
                <div>
                    <label for="classroom-rubric" class="block text-sm font-medium text-gray-700 mb-1">Rúbrica de Evaluación (Opcional)</label>
                    <textarea id="classroom-rubric" rows="4" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Define aquí los criterios de evaluación... (Ej: Resumen 3/10, Coherencia 2/10...)"></textarea>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                    Guardar Aula
                </button>
            </form>
        </div>


        <!-- ============================================= -->
        <!-- VISTA DE ALUMNO (LOGIN) -->
        <!-- ============================================= -->
        <div id="student-login-view" class="view max-w-md mx-auto p-10 bg-white shadow-xl rounded-2xl">
            <h2 class="text-2xl font-semibold mb-6 text-green-700">Acceso de Alumno</h2>
            <form id="student-login-form" class="space-y-4">
                <div>
                    <label for="student-classroom-select" class="block text-sm font-medium text-gray-700 mb-1">1. Selecciona tu Aula</label>
                    <select id="student-classroom-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required>
                        <option value="" disabled selected>Cargando aulas...</option>
                        <!-- Las aulas se cargarán aquí -->
                    </select>
                </div>
                <div>
                    <label for="student-nick" class="block text-sm font-medium text-gray-700 mb-1">2. Introduce tu IDEA o Nick</label>
                    <input type="text" id="student-nick" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Tu IDEA o Nick" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-700 transition shadow-lg">
                    Entrar
                </button>
            </form>
        </div>

    </div> <!-- Fin de #app -->

    <!-- Loader Modal -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="message-title" class="text-xl font-bold mb-4"></h3>
            <p id="message-body"></p>
            <button id="message-close-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                Entendido
            </button>
        </div>
    </div>


    <!-- ============================================= -->
    <!-- SCRIPTS -->
    <!-- ============================================= -->
    <script type="module">
        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (inyectada por el entorno)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aula-ia-default';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de estado
        let userId = null;
        let currentRole = null;
        let unsubscribeClassrooms = () => {};

        // Selectores de UI
        const views = {
            authLoading: document.getElementById('auth-loading-view'),
            role: document.getElementById('role-view'),
            teacherHub: document.getElementById('teacher-hub-view'),
            teacherCreate: document.getElementById('teacher-create-view'),
            studentLogin: document.getElementById('student-login-view')
        };
        const loader = document.getElementById('loader');
        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageBody = document.getElementById('message-body');
        const messageCloseBtn = document.getElementById('message-close-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const roleDisplay = document.getElementById('role-display');

        // --- FUNCIONES DE UTILIDAD (Loader y Mensajes) ---

        function showView(viewId) {
            Object.values(views).forEach(v => v.style.display = 'none');
            if (views[viewId]) {
                views[viewId].style.display = 'block';
            }
        }

        function showLoader(show) {
            loader.classList.toggle('active', show);
        }

        function showMessage(title, body) {
            messageTitle.textContent = title;
            messageBody.textContent = body;
            messageModal.classList.remove('hidden');
        }

        messageCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // --- LÓGICA DE AUTENTICACIÓN Y ROLES ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('session-id').textContent = userId.substring(0, 8) + '...';
                showView('role');
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error de autenticación:", error);
                    showMessage("Error de Conexión", "No se pudo iniciar la sesión. Por favor, recarga la página.");
                }
            }
        });

        document.getElementById('teacher-role-btn').addEventListener('click', () => setRole('teacher'));
        document.getElementById('student-role-btn').addEventListener('click', () => setRole('student'));
        
        logoutBtn.addEventListener('click', () => {
            currentRole = null;
            unsubscribeClassrooms();
            showView('role');
            logoutBtn.classList.add('hidden');
            roleDisplay.textContent = '';
        });

        function setRole(role) {
            currentRole = role;
            if (role === 'teacher') {
                roleDisplay.textContent = 'Profesor';
                roleDisplay.className = 'font-semibold text-lg text-blue-700';
                showView('teacherHub');
                loadTeacherClassrooms();
            } else {
                roleDisplay.textContent = 'Alumno';
                roleDisplay.className = 'font-semibold text-lg text-green-700';
                showView('studentLogin');
                loadStudentClassroomList();
            }
            logoutBtn.classList.remove('hidden');
        }

        // --- LÓGICA DE PROFESOR ---

        const teacherClassroomsList = document.getElementById('teacher-classrooms-list');
        const createClassroomForm = document.getElementById('create-classroom-form');

        // Botones de navegación del profesor
        document.getElementById('show-create-classroom-btn').addEventListener('click', () => {
            showView('teacherCreate');
            createClassroomForm.reset();
        });
        document.getElementById('back-to-hub-btn').addEventListener('click', () => {
            showView('teacherHub');
        });

        // Cargar aulas del profesor (en tiempo real)
        function loadTeacherClassrooms() {
            unsubscribeClassrooms(); // Detener listener anterior
            const classroomsQuery = query(collection(db, `artifacts/${appId}/public/data/classrooms`));
            
            unsubscribeClassrooms = onSnapshot(classroomsQuery, (snapshot) => {
                if (snapshot.empty) {
                    teacherClassroomsList.innerHTML = '<p class="text-gray-500">Aún no has creado ninguna aula.</p>';
                    return;
                }
                
                teacherClassroomsList.innerHTML = ''; // Limpiar lista
                snapshot.forEach(doc => {
                    const classroom = doc.data();
                    const classroomEl = document.createElement('div');
                    classroomEl.className = 'p-4 border rounded-lg hover:bg-gray-50 transition cursor-pointer';
                    classroomEl.innerHTML = `
                        <h4 class="font-semibold text-lg">${classroom.name}</h4>
                        <p class="text-sm text-gray-600">${(classroom.sourceText || '').substring(0, 100)}...</p>
                        <span class="text-xs text-blue-500 font-medium">${classroom.studentList?.length || 0} alumnos</span>
                    `;
                    // Esta acción es para el futuro, como se especificó
                    classroomEl.addEventListener('click', () => {
                        showMessage(
                            "Próximamente", 
                            "Aquí se abriría la aplicación de gestión del aula y el tema, donde añadirías tu API key de iastudio. (Aplicación no construida aún)."
                        );
                    });
                    teacherClassroomsList.appendChild(classroomEl);
                });
            }, (error) => {
                console.error("Error al cargar aulas:", error);
                showMessage("Error de Base de Datos", "No se pudieron cargar las aulas.");
            });
        }

        // Submit del formulario de crear aula
        createClassroomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('classroom-name').value;
            const studentsText = document.getElementById('classroom-students').value;
            const sourceText = document.getElementById('classroom-text').value;
            const rubric = document.getElementById('classroom-rubric').value;

            // Validar campos
            if (!name || !studentsText || !sourceText) {
                showMessage("Campos incompletos", "Por favor, completa el nombre, la lista de alumnos y el texto.");
                return;
            }

            // Procesar lista de alumnos
            const studentList = studentsText.split('\n')
                .map(s => s.trim()) // Quitar espacios
                .filter(s => s.length > 0); // Quitar líneas vacías
            
            if (studentList.length === 0) {
                showMessage("Alumnos Requeridos", "Debes añadir al menos un IDEA o Nick de alumno.");
                return;
            }

            showLoader(true);
            try {
                // Guardar la nueva aula en Firestore
                const classroomsCollection = collection(db, `artifacts/${appId}/public/data/classrooms`);
                await addDoc(classroomsCollection, {
                    name: name,
                    studentList: studentList,
                    sourceText: sourceText,
                    rubric: rubric, // Opcional
                    teacherId: userId,
                    createdAt: serverTimestamp()
                });

                showMessage("¡Éxito!", `El aula "${name}" ha sido creada.`);
                createClassroomForm.reset();
                showView('teacherHub'); // Volver al hub

            } catch (error) {
                console.error("Error creando aula:", error);
                showMessage("Error de Base de Datos", `No se pudo crear el aula: ${error.message}`);
            } finally {
                showLoader(false);
            }
        });


        // --- LÓGICA DE ALUMNO ---

        const studentClassroomSelect = document.getElementById('student-classroom-select');
        const studentLoginForm = document.getElementById('student-login-form');

        // Cargar lista de aulas en el desplegable del alumno
        function loadStudentClassroomList() {
            unsubscribeClassrooms(); // Detener listener anterior
            const classroomsQuery = query(collection(db, `artifacts/${appId}/public/data/classrooms`));
            
            unsubscribeClassrooms = onSnapshot(classroomsQuery, (snapshot) => {
                studentClassroomSelect.innerHTML = '<option value="" disabled selected>Selecciona un aula...</option>'; // Resetear
                
                if (snapshot.empty) {
                    studentClassroomSelect.innerHTML = '<option value="" disabled>No hay aulas disponibles.</option>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const classroom = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = classroom.name;
                    studentClassroomSelect.appendChild(option);
                });
            }, (error) => {
                console.error("Error al cargar aulas (alumno):", error);
                studentClassroomSelect.innerHTML = '<option value="" disabled>Error al cargar aulas.</option>';
            });
        }

        // Login del alumno
        studentLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const classroomId = studentClassroomSelect.value;
            const nick = document.getElementById('student-nick').value.trim();

            if (!classroomId || !nick) {
                showMessage("Campos incompletos", "Debes seleccionar un aula e introducir tu nick.");
                return;
            }

            showLoader(true);
            try {
                // 1. Obtener el documento del aula seleccionada
                const classroomRef = doc(db, `artifacts/${appId}/public/data/classrooms`, classroomId);
                const classroomDoc = await getDoc(classroomRef);

                if (!classroomDoc.exists()) {
                    throw new Error("El aula seleccionada no existe.");
                }

                const classroom = classroomDoc.data();
                
                // 2. Validar si el nick está en la lista de alumnos de esa aula
                if (classroom.studentList && classroom.studentList.includes(nick)) {
                    // ¡Acceso concedido!
                    // Aquí es donde "saltaría a la otra aplicación"
                    showMessage(
                        "Acceso Concedido",
                        `¡Bienvenido, ${nick}! Cargando tu lección... (Aquí comenzaría la aplicación del alumno).`
                    );
                    // Ocultamos el formulario de login como simulación de éxito
                    showView('authLoading'); // O una vista en blanco
                    setTimeout(() => { 
                        logoutBtn.click(); // Deslogueamos para simular que pasó a otra app
                    }, 3000);

                } else {
                    // Acceso denegado
                    showMessage(
                        "Acceso Denegado",
                        "Tu IDEA o Nick no se encuentra en la lista de esta aula. Contacta con tu profesor."
                    );
                }

            } catch (error) {
                console.error("Error en login de alumno:", error);
                showMessage("Error", "No se pudo verificar tu acceso. Inténtalo de nuevo.");
            } finally {
                showLoader(false);
            }
        });


        // --- INICIO DE LA APP ---
        showView('authLoading');
    
    </script>
</body>
</html>
