<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaIA - Acceso Profesorado</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .view { display: none; }
        .card { max-width: 600px; }
        .btn-primary { 
            background-color: #4f46e5; color: white; transition: background-color 0.2s; 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:hover { background-color: #4338ca; }
        #loader {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7);
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 4px solid #ffffff; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message-box { display: none; }
        .message-box.active { display: block; }
        .tag { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Vista de Login -->
    <div id="login-view" class="card bg-white p-8 rounded-xl shadow-2xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">Acceso Profesorado</h1>
        <p class="text-sm text-gray-500 mb-6 text-center">Inicia sesión para gestionar tus aulas.</p>
        
        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico:</label>
        <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
        
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contraseña:</label>
        <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
        
        <button id="login-btn" class="btn-primary w-full py-3 rounded-xl text-lg font-semibold">
            Iniciar Sesión
        </button>
        
        <button onclick="window.location.href='index.html'" class="w-full text-center mt-4 text-sm text-gray-500 hover:text-gray-700 transition">
            &larr; Volver al Inicio
        </button>
    </div>

    <!-- Vista de Gestión de Aulas -->
    <div id="management-view" class="view card bg-white p-8 rounded-xl shadow-2xl w-full">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Mis Aulas</h1>
            <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 transition">Cerrar Sesión</button>
        </div>
        <p class="text-sm text-gray-500 mb-4">ID de Profesor: <span id="user-id" class="font-mono text-xs bg-gray-100 p-1 rounded">Cargando...</span></p>

        <!-- Formulario para Nueva Aula -->
        <div class="border border-indigo-200 p-4 rounded-lg bg-indigo-50 mb-6">
            <h2 class="text-xl font-semibold text-indigo-800 mb-3">Crear Nueva Aula</h2>
            <label for="new-aula-name" class="block text-sm font-medium text-indigo-700 mb-2">Nombre del Aula:</label>
            <div class="flex space-x-2">
                <input type="text" id="new-aula-name" placeholder="Ej: 1º Bachillerato A" class="flex-grow p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <button id="add-aula-btn" class="btn-primary px-4 py-3 rounded-lg text-sm font-semibold">
                    Añadir Aula
                </button>
            </div>
        </div>

        <!-- Lista de Aulas -->
        <div id="aulas-list" class="space-y-4">
            <p class="text-center text-gray-500 py-8">Cargando tus aulas...</p>
        </div>
    </div>
    
    <!-- Modal de Edición/Alumnado -->
    <div id="edit-modal" class="message-box fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4" role="dialog" aria-modal="true">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4">Gestión de Alumnado</h3>
            <p class="text-sm text-gray-500 mb-4">Añade o edita los IDs/Nicks de los alumnos, separados por comas. (Ej: P01, P02, Manolo, Laura)</p>
            
            <textarea id="alumnado-textarea" rows="6" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm font-mono text-sm"></textarea>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="py-2 px-4 rounded-lg text-gray-600 border border-gray-300 hover:bg-gray-50 transition">Cancelar</button>
                <button id="save-alumnado-btn" class="btn-primary py-2 px-4 rounded-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Message Box (Modal) para errores y mensajes -->
    <div id="message-modal" class="message-box fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="message-title">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <h3 id="message-title" class="text-xl font-bold text-gray-900 mb-3"></h3>
            <p id="message-text" class="text-gray-600 mb-6"></p>
            <button onclick="document.getElementById('message-modal').classList.remove('active')" class="btn-primary py-2 px-6 rounded-lg text-sm">Cerrar</button>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p class="text-white text-lg mt-3">Cargando...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ***************************************************************
        // --- REEMPLAZA ESTO CON TU CONFIG DE FIREBASE REAL ---
        // ***************************************************************
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };
        
        // ***************************************************************

        // Variables de la aplicación
        let app, db, auth;
        const appId = firebaseConfig.projectId; // Usamos el ProjectId como app ID
        let userId = null;
        let currentAulaToEdit = null;

        // Elementos del DOM
        const loginView = document.getElementById('login-view');
        const managementView = document.getElementById('management-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const aulasList = document.getElementById('aulas-list');
        const addAulaBtn = document.getElementById('add-aula-btn');
        const newAulaNameInput = document.getElementById('new-aula-name');
        const userIdSpan = document.getElementById('user-id');
        const loader = document.getElementById('loader');
        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const editModal = document.getElementById('edit-modal');
        const alumnadoTextarea = document.getElementById('alumnado-textarea');
        const saveAlumnadoBtn = document.getElementById('save-alumnado-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');


        // Funciones de utilidad
        function showLoader(show) {
            loader.style.display = show ? 'flex' : 'none';
        }

        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageModal.classList.add('active');
        }
        
        function showView(viewId) {
            loginView.style.display = viewId === 'login' ? 'block' : 'none';
            managementView.style.display = viewId === 'management' ? 'block' : 'none';
        }

        // 1. Inicialización de Firebase
        try {
            // setLogLevel('Debug'); // Descomentar para ver logs
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            showView('login');
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            showMessage("Error Crítico", "No se pudo conectar con el sistema. Revisa la consola y la configuración de Firebase.");
        }

        // 2. Listener de Estado de Autenticación
        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) {
                // Usuario Profesor autenticado (no anónimo)
                userId = user.uid;
                userIdSpan.textContent = userId;
                showView('management');
                loadAulas();
            } else {
                // No autenticado o es un usuario anónimo (debe hacer login)
                userId = null;
                userIdSpan.textContent = 'N/A';
                showView('login');
                // Intentar iniciar sesión anónimamente para tener un token válido para el sistema
                signInAnonymously(auth).catch(e => console.warn("Error al intentar signInAnonymously:", e));
            }
            showLoader(false);
        });

        // 3. Lógica de Login
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                showMessage("Error", "Introduce correo y contraseña.");
                return;
            }

            showLoader(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged manejará la vista
                showMessage("Éxito", "Sesión iniciada correctamente.");
            } catch (error) {
                console.error("Error de login:", error.code, error.message);
                showMessage("Error de Login", "Credenciales inválidas. (Código: " + error.code + ")");
            } finally {
                showLoader(false);
            }
        });
        
        // 4. Lógica de Logout
        logoutBtn.addEventListener('click', async () => {
            showLoader(true);
            try {
                await signOut(auth);
                // onAuthStateChanged manejará la vista
                showMessage("Información", "Sesión cerrada correctamente.");
            } catch (error) {
                console.error("Error de logout:", error);
                showMessage("Error", "No se pudo cerrar la sesión.");
            } finally {
                showLoader(false);
            }
        });

        // 5. Carga de Aulas en Tiempo Real
        function loadAulas() {
            if (!userId) {
                aulasList.innerHTML = '<p class="text-center text-red-500 py-8">Error: ID de usuario no disponible. Intenta iniciar sesión de nuevo.</p>';
                return;
            }

            // Usamos la colección pública para las aulas del profesorado
            const aulasCollectionRef = collection(db, `artifacts/${appId}/public/data/aulas`);
            // Query para obtener solo las aulas creadas por este profesor (userId)
            const q = query(aulasCollectionRef); 

            onSnapshot(q, (snapshot) => {
                aulasList.innerHTML = ''; // Limpiar lista
                
                if (snapshot.empty) {
                    aulasList.innerHTML = '<p class="text-center text-gray-500 py-8">Aún no has creado ninguna aula.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const aula = doc.data();
                    // Solo mostrar aulas creadas por el usuario actual
                    if (aula.profesorId === userId) {
                         renderAula(doc.id, aula);
                    }
                });
                
                if (aulasList.innerHTML === '') {
                    aulasList.innerHTML = '<p class="text-center text-gray-500 py-8">Aún no has creado ninguna aula.</p>';
                }
            }, (error) => {
                console.error("Error al escuchar las aulas:", error);
                aulasList.innerHTML = '<p class="text-center text-red-500 py-8">Error al cargar las aulas.</p>';
            });
        }
        
        // Función para renderizar una aula en la lista
        function renderAula(id, aula) {
            const numAlumnos = (aula.alumnado && Array.isArray(aula.alumnado)) ? aula.alumnado.length : 0;
            const item = document.createElement('div');
            item.className = 'bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex justify-between items-center';
            item.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">${aula.nombreAula}</h3>
                    <p class="text-sm text-gray-500">ID de Aula: <span class="tag bg-yellow-100 text-yellow-800">${id}</span></p>
                    <p class="text-sm text-gray-500">${numAlumnos} alumnos registrados.</p>
                </div>
                <div class="flex space-x-2">
                    <button data-id="${id}" data-alumnado='${JSON.stringify(aula.alumnado || [])}' class="edit-alumnado-btn py-2 px-4 rounded-lg bg-green-500 text-white text-sm font-medium hover:bg-green-600 transition">Alumnado</button>
                    <button data-id="${id}" class="delete-aula-btn py-2 px-4 rounded-lg bg-red-500 text-white text-sm font-medium hover:bg-red-600 transition">Eliminar</button>
                </div>
            `;
            aulasList.appendChild(item);
        }


        // 6. Añadir Nueva Aula
        addAulaBtn.addEventListener('click', async () => {
            const aulaName = newAulaNameInput.value.trim();
            if (!aulaName) {
                showMessage("Error", "El nombre del aula no puede estar vacío.");
                return;
            }
            if (!userId) {
                showMessage("Error", "Debes iniciar sesión para crear aulas.");
                return;
            }

            showLoader(true);
            try {
                const aulasCollectionRef = collection(db, `artifacts/${appId}/public/data/aulas`);
                await addDoc(aulasCollectionRef, {
                    nombreAula: aulaName,
                    profesorId: userId,
                    alumnado: [],
                    createdAt: new Date().toISOString()
                });
                newAulaNameInput.value = '';
                showMessage("Éxito", `Aula "${aulaName}" creada correctamente.`);
            } catch (error) {
                console.error("Error al añadir aula:", error);
                showMessage("Error", "No se pudo añadir el aula. Revisa permisos.");
            } finally {
                showLoader(false);
            }
        });

        // 7. Event Delegation para Eliminar Aula
        aulasList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-aula-btn')) {
                const aulaId = e.target.dataset.id;
                if (!confirm('¿Estás seguro de que quieres eliminar esta aula? Esta acción es permanente.')) {
                    return;
                }
                
                showLoader(true);
                try {
                    const aulaDocRef = doc(db, `artifacts/${appId}/public/data/aulas`, aulaId);
                    await deleteDoc(aulaDocRef);
                    showMessage("Éxito", "Aula eliminada correctamente.");
                } catch (error) {
                    console.error("Error al eliminar aula:", error);
                    showMessage("Error", "No se pudo eliminar el aula. Revisa permisos.");
                } finally {
                    showLoader(false);
                }
            }
        });

        // 8. Event Delegation para Editar Alumnado (Abrir Modal)
        aulasList.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-alumnado-btn')) {
                const aulaId = e.target.dataset.id;
                const alumnadoData = e.target.dataset.alumnado;
                
                currentAulaToEdit = aulaId;
                const alumnadoArray = JSON.parse(alumnadoData);
                // Convertir el array a una cadena separada por comas para el textarea
                alumnadoTextarea.value = alumnadoArray.join(', ');
                
                document.getElementById('modal-title').textContent = `Alumnado - Aula ID: ${aulaId}`;
                editModal.classList.add('active');
            }
        });
        
        // 9. Guardar Alumnado Editado
        saveAlumnadoBtn.addEventListener('click', async () => {
            if (!currentAulaToEdit) return;

            const inputString = alumnadoTextarea.value.trim();
            // Limpiar y normalizar la lista de alumnos: separar por coma, quitar espacios y filtros vacíos
            const newAlumnadoArray = inputString.split(',')
                                                .map(nick => nick.trim())
                                                .filter(nick => nick.length > 0);

            showLoader(true);
            try {
                const aulaDocRef = doc(db, `artifacts/${appId}/public/data/aulas`, currentAulaToEdit);
                await updateDoc(aulaDocRef, {
                    alumnado: newAlumnadoArray
                });
                
                editModal.classList.remove('active');
                showMessage("Éxito", `Lista de alumnado para el aula ${currentAulaToEdit} actualizada.`);
                currentAulaToEdit = null;
            } catch (error) {
                console.error("Error al guardar alumnado:", error);
                showMessage("Error", "No se pudo actualizar la lista de alumnado.");
            } finally {
                showLoader(false);
            }
        });
        
        // 10. Cancelar Edición
        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.remove('active');
            currentAulaToEdit = null;
        });

        // Iniciar la carga al cargar el documento (y esperar el onAuthStateChanged)
        document.addEventListener('DOMContentLoaded', () => {
            // No hacer nada aquí, onAuthStateChanged manejará la lógica de la vista
        });
    </script>
</body>
</html>
