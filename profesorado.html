<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaIA - Profesorado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; }
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view { display: none; }
        .ai-btn { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #e5e7eb; transition: 0.2s; background: white; }
        .ai-btn:hover { background: #f3f4f6; border-color: #d1d5db; }
    </style>
</head>
<body class="p-4">
    
    <!-- LOGIN -->
    <div id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl mt-10 text-center">
        <h1 class="text-2xl font-bold mb-6">Acceso Profesorado</h1>
        <button id="google-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition mb-4">
            Iniciar con Google
        </button>
        <button onclick="window.location.href='index.html'" class="mt-4 text-sm text-gray-500">Volver</button>
    </div>

    <!-- APP VIEW -->
    <div id="app-view" class="view max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
        
        <!-- Columna Izquierda: Editor -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="form-title" class="text-xl font-bold text-gray-800">Crear Nueva Aula</h2>
                    <button onclick="resetForm()" class="text-xs text-gray-400 underline">Limpiar</button>
                </div>
                
                <input type="hidden" id="edit-id">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                        <input id="aula-name" class="w-full p-2 border rounded" placeholder="Ej: Historia T1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Alumnos (IDs)</label>
                        <textarea id="aula-students" class="w-full p-2 border rounded h-20 text-sm font-mono" placeholder="juan, maria, pedro... (separados por coma o l√≠nea)"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Texto de Estudio</label>
                        <textarea id="aula-text" class="w-full p-2 border rounded h-40 text-sm" placeholder="Pega aqu√≠ el texto..."></textarea>
                        
                        <!-- Botonera IA -->
                        <div class="mt-2 flex gap-2 flex-wrap">
                            <button onclick="askGemini('concepts')" class="ai-btn text-indigo-600">üß† Extraer Conceptos</button>
                            <button onclick="askGemini('rubric')" class="ai-btn text-purple-600">üìù Generar R√∫brica</button>
                            <button onclick="askGemini('feedback')" class="ai-btn text-green-600">üí° Sugerir Feedback</button>
                        </div>
                        <div id="ai-result" class="mt-2 p-3 bg-gray-50 border rounded text-sm text-gray-700 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">R√∫brica</label>
                        <textarea id="aula-rubric" class="w-full p-2 border rounded h-24 text-sm"></textarea>
                    </div>
                </div>

                <div class="mt-6 text-right">
                    <button id="save-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 transition">Guardar Aula</button>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Lista -->
        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-lg sticky top-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">Mis Aulas</h2>
                    <button id="logout-btn" class="text-xs text-red-500 font-bold border border-red-100 px-2 py-1 rounded hover:bg-red-50">Salir</button>
                </div>
                <div id="aulas-list" class="space-y-3 max-h-[80vh] overflow-y-auto">
                    <p class="text-center text-gray-400 text-sm">Cargando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, addDoc, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrZRRrK2pV8-qgbv4SkutKE2LSQFPJE-Q",
            authDomain: "aulaia-393c0.firebaseapp.com",
            projectId: "aulaia-393c0",
            storageBucket: "aulaia-393c0.appspot.com",
            messagingSenderId: "485029010497",
            appId: "1:485029010497:web:1ebf3b0a80781d30307ac0"
        };
        const PORTAL_ALUMNOS = "https://vferjim688-droid.github.io/Alumnado/llave_acceso.html";
        const GEMINI_API_KEY = ""; // La clave se inyecta en runtime

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentAulas = []; // Para guardar los datos en memoria

        const loader = document.getElementById('loader');

        // Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'grid';
                loadAulas();
            } else {
                document.getElementById('login-view').style.display = 'block';
                document.getElementById('app-view').style.display = 'none';
            }
        });

        document.getElementById('google-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            // provider.setCustomParameters({ 'hd': 'g.educaand.es' }); // Opcional
            try { await signInWithPopup(auth, provider); } catch (e) { alert(e.message); }
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // Cargar Aulas
        function loadAulas() {
            const q = query(collection(db, `artifacts/aulaia-393c0/public/data/classrooms`), where("teacherId", "==", currentUser.email));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('aulas-list');
                list.innerHTML = '';
                currentAulas = []; // Reset memoria

                if (snap.empty) {
                    list.innerHTML = '<p class="text-center text-gray-400 text-sm">No tienes aulas.</p>';
                    return;
                }

                snap.forEach(d => {
                    const data = d.data();
                    // Guardamos en memoria para editar r√°pido
                    currentAulas.push({ id: d.id, ...data });

                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded border hover:shadow-md transition group";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-sm text-gray-800">${data.name}</h4>
                            <span class="text-xs bg-gray-100 px-1 rounded">${data.studentList.length} alum</span>
                        </div>
                        <div class="mt-3 flex justify-between items-center border-t pt-2">
                            <a href="${PORTAL_ALUMNOS}?aulaId=${d.id}" target="_blank" class="text-blue-600 text-xs hover:underline">üîó Link Alumno</a>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editar('${d.id}')" class="text-gray-400 hover:text-blue-600">‚úèÔ∏è</button>
                                <button onclick="borrar('${d.id}')" class="text-gray-400 hover:text-red-600">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        // Guardar
        document.getElementById('save-btn').addEventListener('click', async () => {
            const name = document.getElementById('aula-name').value.trim();
            const students = document.getElementById('aula-students').value.split(/[\n,]+/).map(s=>s.trim()).filter(s=>s);
            const text = document.getElementById('aula-text').value;
            const rubric = document.getElementById('aula-rubric').value;
            const editId = document.getElementById('edit-id').value;

            if(!name || !students.length) return alert("Falta nombre o alumnos.");

            loader.style.display = 'flex';
            const col = collection(db, `artifacts/aulaia-393c0/public/data/classrooms`);
            
            try {
                const data = { 
                    name, studentList: students, sourceText: text, rubric, 
                    teacherId: currentUser.email, updatedAt: serverTimestamp() 
                };

                if(editId) {
                    await updateDoc(doc(col, editId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(col, data);
                }
                resetForm();
            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                loader.style.display = 'none';
            }
        });

        // IA_Gemini
        window.askGemini = async (type) => {
            const text = document.getElementById('aula-text').value.trim();
            if (!text) return alert("Pega el texto primero.");
            
            const resultBox = document.getElementById('ai-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = "‚ú® Pensando...";
            
            let prompt = "";
            if (type === 'concepts') prompt = `Extrae 5 conceptos clave de este texto: "${text.substring(0,3000)}..."`;
            if (type === 'rubric') prompt = `Crea una r√∫brica breve (3 puntos) para evaluar un resumen de este texto: "${text.substring(0,3000)}..."`;
            if (type === 'feedback') prompt = `Dame 2 ejemplos de feedback (t√©cnico y motivacional) para un alumno sobre este texto: "${text.substring(0,3000)}..."`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const ans = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
                
                if (type === 'rubric') document.getElementById('aula-rubric').value = ans;
                resultBox.innerText = ans;
            } catch (e) {
                resultBox.innerText = "Error IA: " + e.message;
            }
        };

        // Utilidades Globales
        window.resetForm = () => {
            document.getElementById('aula-name').value = '';
            document.getElementById('aula-students').value = '';
            document.getElementById('aula-text').value = '';
            document.getElementById('aula-rubric').value = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('form-title').innerText = "Crear Nueva Aula";
            document.getElementById('ai-result').style.display = 'none';
        };

        window.editar = (id) => {
            const aula = currentAulas.find(a => a.id === id);
            if(!aula) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('aula-name').value = aula.name;
            document.getElementById('aula-students').value = aula.studentList.join('\n');
            document.getElementById('aula-text').value = aula.sourceText || '';
            document.getElementById('aula-rubric').value = aula.rubric || '';
            document.getElementById('form-title').innerText = "Editando: " + aula.name;
        };

        window.borrar = async (id) => {
            if(confirm("¬øBorrar?")) await deleteDoc(doc(db, `artifacts/aulaia-393c0/public/data/classrooms`, id));
        };
    </script>
</body>
</html>
