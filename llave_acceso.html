<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AulaIA - Llave de Acceso</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        #loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #loader.active { opacity: 1; visibility: visible; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            border-top: 4px solid #ffffff; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilo para el modal de mensaje */
        #messageModal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; align-items: center; justify-content: center;
            z-index: 10000;
        }
        #messageModal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Tarjeta Principal de Acceso -->
    <div id="roleSelection" class="view card bg-white p-8 rounded-xl shadow-2xl space-y-6 max-w-md w-full">
        <h1 class="text-3xl font-bold text-gray-800 text-center">AulaIA: Llave de Acceso</h1>
        
        <div class="space-y-4">
            <!-- Selector de Aula para Alumnado -->
            <div>
                <label for="aulaSelect" class="block text-sm font-medium text-gray-700 mb-1">Selecciona tu Aula:</label>
                <select id="aulaSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm bg-gray-50">
                    <option value="" disabled selected>Cargando aulas...</option>
                </select>
            </div>
            
            <!-- Entrada de Nick/IDEA para Alumnado -->
            <div>
                <label for="studentNickInput" class="block text-sm font-medium text-gray-700 mb-1">Introduce tu IDEA o Nick:</label>
                <input type="text" id="studentNickInput" placeholder="Ej: vferjim688" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm">
            </div>

            <!-- Botón de Acceso Alumnado -->
            <button id="studentLoginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                Acceder como Alumnado
            </button>
        </div>
        
        <p class="text-sm text-center text-gray-500 pt-4 border-t border-gray-200">
            ¿Eres profesor? 
            <a href="INDEX-LlaveAcceso-Profesorado.html" class="text-blue-600 hover:text-blue-800 font-medium transition duration-150">Accede aquí.</a>
        </p>
    </div>

    <!-- Modal de Carga -->
    <div id="loader">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p class="mt-4 text-white text-lg">Cargando...</p>
        </div>
    </div>
    
    <!-- Modal de Mensajes -->
    <div id="messageModal">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full text-center transform scale-100 transition-transform duration-300">
            <h3 id="messageTitle" class="text-xl font-bold text-gray-800 mb-2">Título</h3>
            <p id="messageText" class="text-gray-600 mb-4">Mensaje de prueba</p>
            <button id="closeMessageBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 w-full">
                Aceptar
            </button>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================================
        // FIREBASE CONFIGURACIÓN Y AUTENTICACIÓN
        // =======================================================================
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Configuración de Logging de Firebase (opcional, para debug)
        setLogLevel('error');

        // =======================================================================
        // CONFIGURACIÓN DE LA APLICACIÓN
        // =======================================================================
        
        // Configuración - DEBES CAMBIAR ESTA URL
        // Esta URL debe apuntar a la página principal de la actividad del alumnado
        // que ha sido desplegada correctamente (ej: https://[usuario-github].github.io/Alumnado/)
        // Usamos la URL que parece ser tu repositorio:
        const ACTIVIDAD_APP_URL = "https://vferjim688-droid.github.io/Alumnado/"; // <--- ¡VERIFICA ESTA URL!

        // =======================================================================
        // FUNCIONES DE UTILIDAD
        // =======================================================================

        const aulaSelect = document.getElementById('aulaSelect');
        const studentNickInput = document.getElementById('studentNickInput');
        const studentLoginBtn = document.getElementById('studentLoginBtn');
        const loader = document.getElementById('loader');
        const messageModal = document.getElementById('messageModal');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');

        function showLoader(isVisible) {
            if (isVisible) {
                loader.classList.add('active');
            } else {
                loader.classList.remove('active');
            }
        }

        function showMessage(title, message) {
            messageTitle.textContent = title;
            messageText.textContent = message;
            messageModal.classList.add('active');
        }

        closeMessageBtn.addEventListener('click', () => {
            messageModal.classList.remove('active');
        });

        // Función para poblar el selector de aulas
        function populateAulas(aulas) {
            aulaSelect.innerHTML = '<option value="" disabled selected>Selecciona tu aula...</option>'; // Reinicia y añade el placeholder

            if (aulas.length === 0) {
                 aulaSelect.innerHTML = '<option value="" disabled selected>No hay aulas disponibles.</option>';
                 studentLoginBtn.disabled = true;
                 studentNickInput.disabled = true;
                 return;
            }
            
            aulas.forEach(aula => {
                const option = document.createElement('option');
                option.value = aula.id;
                option.textContent = `${aula.id} - ${aula.alumnado.length} alumnos`;
                
                // Almacenar la lista de alumnos en el dataset para el check de login
                option.dataset.studentList = JSON.stringify(aula.alumnado || []);
                
                aulaSelect.appendChild(option);
            });
            studentLoginBtn.disabled = false;
            studentNickInput.disabled = false;
        }

        // =======================================================================
        // AUTENTICACIÓN Y CARGA INICIAL
        // =======================================================================
        
        let isAuthReady = false;

        async function initAuth() {
            try {
                if (initialAuthToken) {
                    // Usar token de autenticación si está disponible (entorno canvas)
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Si no hay token, iniciar sesión anónimamente
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error de autenticación inicial:", error);
                showMessage("Error de Autenticación", "No se pudo conectar al servidor de autenticación.");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuario autenticado:", user.uid);
                isAuthReady = true;
                // Una vez autenticado, comenzamos a escuchar los datos
                startDataListener(); 
            } else {
                console.log("Usuario no autenticado. Iniciando sesión...");
                initAuth();
            }
        });

        // =======================================================================
        // SINCRONIZACIÓN DE DATOS CON FIRESTORE
        // =======================================================================
        
        function startDataListener() {
            if (!isAuthReady) return;

            // Escuchamos la colección de aulas para el rol de alumno
            const aulasColRef = collection(db, `artifacts/${appId}/public/data/aulas`);
            
            // onSnapshot proporciona una escucha en tiempo real
            onSnapshot(aulasColRef, (snapshot) => {
                showLoader(true);
                const aulas = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Aseguramos que la lista de alumnado sea un array
                    const alumnado = Array.isArray(data.alumnado) ? data.alumnado : []; 
                    
                    aulas.push({
                        id: doc.id,
                        alumnado: alumnado
                    });
                });
                
                populateAulas(aulas);
                document.getElementById('roleSelection').classList.remove('view');
                showLoader(false);

            }, (error) => {
                console.error("Error al escuchar las aulas:", error);
                showMessage("Error de Datos", "No se pudo cargar la lista de aulas. Inténtalo de nuevo más tarde.");
                showLoader(false);
            });
        }
        
        // =======================================================================
        // Lógica de acceso del Alumnado
        // =======================================================================
        studentLoginBtn.addEventListener('click', () => {
            const selectedOption = aulaSelect.options[aulaSelect.selectedIndex];
            const selectedAulaId = selectedOption.value;
            const studentNick = studentNickInput.value.trim();

            if (!selectedAulaId || selectedAulaId === '') {
                showMessage("Error de Selección", "Por favor, selecciona tu aula.");
                return;
            }

            if (!studentNick || studentNick === '') {
                showMessage("Error de Entrada", "Por favor, introduce tu IDEA o Nick.");
                return;
            }

            showLoader(true);
            try {
                // 1. Obtener la lista de alumnos (ya la tenemos en el 'dataset' del option)
                // Usamos JSON.parse para convertir la cadena del dataset de vuelta a un array
                const studentList = JSON.parse(selectedOption.dataset.studentList || '[]');

                // 2. Comprobar si el Nick/IDEA del alumno está en la lista (comparación sin distinción entre mayúsculas y minúsculas)
                const isStudentAuthorized = studentList.some(nick => nick.toLowerCase() === studentNick.toLowerCase());

                if (isStudentAuthorized) {
                    // 3. ¡Autorizado! Construir la URL y redirigir
                    if (!ACTIVIDAD_APP_URL || ACTIVIDAD_APP_URL === "https://example-user.github.io/Alumnado/") {
                         showMessage("Error de Configuración", "La URL de la actividad del alumno no está configurada correctamente. Contacta con tu profesor.");
                         return;
                    }
                    
                    const url = `${ACTIVIDAD_APP_URL}?aulaId=${selectedAulaId}&alumnoId=${encodeURIComponent(studentNick)}`;
                    
                    showMessage("Acceso Concedido", "Redirigiendo a tu actividad...");
                    setTimeout(() => { 
                         // Redirigimos al alumno a la aplicación de la actividad
                         window.location.href = url; 
                    }, 1500);

                } else {
                    // 4. No autorizado
                    throw new Error("Tu IDEA o Nick no está en la lista de esta aula. Contacta con tu profesor.");
                }

            } catch (error) {
                console.error("Error en el login de alumno:", error);
                showMessage("Acceso Denegado", error.message);
            } finally {
                showLoader(false);
            }
        });

    </script>
</body>
</html>
